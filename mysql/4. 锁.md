# 锁

## 1 lock 与 latch

- latch一般称为闩锁（轻量级锁），要求锁定的时间必须非常短
- InnoDB中，latch可以分为mutex（互斥量）和rwlock（读写锁），目的是用来保证并发线程操作临界资源的正确性，并且通常没有死锁检测机制

- lock的对象是事务，用来锁定的是数据库中的对象，如表、页、行。
- lock的对象仅在事务commit或rollback后进行释放


![Alt text](https://raw.githubusercontent.com/zhangtao6483/note/master/img/mysql/innodb7.png)

## 2 存储引擎中的锁

### 2.1 锁的类型

行级锁：

1. 共享锁（S Lock），允许事务读一行数据
2. 排它锁（X Lock），允许事务删除或更新一行数据

![Alt text](https://raw.githubusercontent.com/zhangtao6483/note/master/img/mysql/innodb8.png)

- X锁与任何的锁都不兼容，而S锁仅和S锁兼容
- S锁和X锁都是行锁
- 为了支持不同粒度上的加锁操作，允许事务在行级锁和表级锁上的锁同时存在，称之为意向锁（Intention Lock）。
- 加锁顺序：首先对粗粒度的对象上锁（对库、表、页上加意向锁），再对细粒度对象上锁

两种意向锁：

1. 意向共享锁（IS Lock），事务想要获得一张表中某几行的共享锁
2. 意向排它锁（IX Lock），事务想要获得一张表中某几行的排他锁

![Alt text](https://raw.githubusercontent.com/zhangtao6483/note/master/img/mysql/innodb9.png)

### 2.2 一致性非锁定读

![Alt text](https://raw.githubusercontent.com/zhangtao6483/note/master/img/mysql/innodb9.png)

